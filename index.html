<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --neon: #00e676;
            --neon-glow: rgba(0, 230, 118, 0.2);
            --bg: #0a0a0a;
            --bg-secondary: #121212;
            --card: #1a1a1a;
            --card-hover: #202020;
            --blue: #00e5ff;
            --blue-glow: rgba(0, 229, 255, 0.2);
            --red: #ff3d00;
            --orange: #ff9100;
            --text-primary: #f0f0f0;
            --text-secondary: #999;
            --border: #2a2a2a;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.6;
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }
        
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-box {
            background: var(--card);
            padding: 40px;
            border-radius: 16px;
            border: 2px solid var(--neon);
            max-width: 400px;
            width: 100%;
        }
        
        .login-box h2 {
            color: var(--neon);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .nav {
            display: flex;
            background: var(--card);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow-x: auto;
        }
        
        .nav button {
            flex: 1;
            padding: 18px 12px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 10px;
            font-weight: 700;
            min-width: 80px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav button:hover {
            background: rgba(0, 230, 118, 0.05);
            color: var(--neon);
        }
        
        .nav button.active {
            color: var(--neon);
        }
        
        .nav button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--neon);
            box-shadow: 0 0 10px var(--neon-glow);
        }
        
        .user-info {
            background: var(--bg-secondary);
            padding: 10px 20px;
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .user-info strong {
            color: var(--neon);
        }
        
        .logout-btn {
            background: none;
            border: 1px solid var(--red);
            color: var(--red);
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 10px;
        }
        
        .container {
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }
        
        .panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .panel.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .panel-header h2 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--neon), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .sync-btn {
            background: linear-gradient(135deg, var(--card), var(--bg-secondary));
            color: var(--neon);
            border: 1px solid var(--neon);
            padding: 14px 24px;
            border-radius: 12px;
            width: 100%;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 24px;
            font-size: 13px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px var(--neon-glow);
        }
        
        .sync-btn:hover {
            background: var(--neon);
            color: var(--bg);
            box-shadow: 0 0 30px var(--neon-glow);
            transform: translateY(-2px);
        }
        
        .sync-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .export-btn {
            background: var(--blue);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--bg);
            cursor: pointer;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            box-shadow: 0 0 20px var(--blue-glow);
            transform: translateY(-2px);
        }
        
        .save-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--neon), #00c853);
            color: var(--bg);
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px var(--neon-glow);
            margin-top: 8px;
        }
        
        .save-btn:hover {
            box-shadow: 0 6px 30px var(--neon-glow);
            transform: translateY(-2px);
        }
        
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .calc-box {
            background: linear-gradient(135deg, var(--card), var(--bg-secondary));
            padding: 20px;
            border-radius: 16px;
            border-left: 4px solid var(--neon);
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .calc-box:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }
        
        .val {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-top: 8px;
        }
        
        .label-sm {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 1px;
            display: block;
        }
        
        .stock-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--card);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }
        
        .stock-row:hover {
            background: var(--card-hover);
            border-color: var(--neon);
            transform: translateX(4px);
        }
        
        .stock-row span:last-child {
            color: var(--neon);
        }
        
        input, select {
            width: 100%;
            padding: 14px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--neon);
            box-shadow: 0 0 0 3px var(--neon-glow);
            background: var(--bg-secondary);
        }
        
        input::placeholder {
            color: var(--text-secondary);
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .section-header {
            font-size: 13px;
            font-weight: 700;
            color: var(--neon);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 24px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }
        
        .setup-panel {
            background: var(--card);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid var(--neon);
            margin-top: 40px;
        }
        
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .inventory-table th {
            background: var(--card);
            padding: 12px;
            text-align: left;
            font-size: 11px;
            color: var(--neon);
            border-bottom: 2px solid var(--border);
        }
        
        .inventory-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        
        .inventory-table tr:hover {
            background: var(--card-hover);
        }
        
        @media (max-width: 480px) {
            .container { padding: 15px; }
            .nav button { font-size: 9px; min-width: 70px; padding: 15px 8px; }
            .val { font-size: 24px; }
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <h2>üîê Login</h2>
        <label class="label-sm">Username</label>
        <input type="text" id="loginUsername" placeholder="Enter username">
        <label class="label-sm">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter password">
        <button class="save-btn" onclick="doLogin()">üîì Login</button>
        <p style="font-size: 11px; color: var(--text-secondary); margin-top: 20px; text-align: center;">
            Default credentials:<br>
            Admin: admin / admin<br>
            Supervisor: supervisor / supervisor
        </p>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display: none;">
    <div class="user-info">
        <strong id="currentUser"></strong>
        <button class="logout-btn" onclick="openPasswordManager()" style="margin-right: 10px; border-color: var(--blue); color: var(--blue);">üîê Password</button>
        <button class="logout-btn" onclick="doLogout()">Logout</button>
    </div>
    
    <div class="nav" id="mainNav"></div>

    <div class="container">
        <!-- SETUP PANEL -->
        <div id="setup" class="panel">
            <div class="setup-panel">
                <h3 style="color: var(--neon); margin-bottom: 20px;">üöÄ Setup Supabase Database</h3>
                
                <label class="label-sm">Supabase URL</label>
                <input type="text" id="supabase_url" placeholder="https://xxxxx.supabase.co">
                
                <label class="label-sm">Supabase Anon Key</label>
                <input type="text" id="supabase_key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                
                <button class="save-btn" onclick="testConnection()" style="background: var(--blue); margin-bottom: 10px;">üîå Test Connection</button>
                <button class="save-btn" onclick="saveSupabaseConfig()">üíæ Save Configuration</button>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                        <strong>Run this SQL in Supabase:</strong>
                    </p>
                    <pre style="background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 11px;">CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  role TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Insert default users
INSERT INTO users (username, password, role) VALUES 
  ('admin', 'admin', 'admin'),
  ('supervisor', 'supervisor', 'supervisor');

CREATE TABLE lots (
  id SERIAL PRIMARY KEY,
  lot_id TEXT UNIQUE NOT NULL,
  cost DECIMAL NOT NULL,
  status TEXT DEFAULT 'ACTIVE',
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE blocks (
  id SERIAL PRIMARY KEY,
  lot_id TEXT NOT NULL,
  block_id TEXT NOT NULL,
  length DECIMAL,
  width DECIMAL,
  height DECIMAL,
  volume DECIMAL,
  status TEXT DEFAULT 'ACTIVE',
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE slabs (
  id SERIAL PRIMARY KEY,
  block_id TEXT NOT NULL,
  slab_number TEXT,
  status TEXT NOT NULL,
  length DECIMAL,
  height DECIMAL,
  sqft DECIMAL,
  thickness TEXT,
  rate DECIMAL,
  value DECIMAL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE sales (
  id SERIAL PRIMARY KEY,
  slab_id INTEGER REFERENCES slabs(id),
  lot_id TEXT,
  block_id TEXT,
  slab_number TEXT,
  customer_name TEXT,
  original_sqft DECIMAL,
  sold_sqft DECIMAL,
  price_per_sqft DECIMAL,
  total_value DECIMAL,
  shrinkage_sqft DECIMAL,
  created_at TIMESTAMP DEFAULT NOW()
);</pre>
                </div>
            </div>
        </div>

        <!-- DASHBOARD PANEL -->
        <div id="summary" class="panel">
            <button class="sync-btn" onclick="refreshData()">üîÑ Sync Dashboard</button>
            
            <div class="calc-box" style="border-left-color: var(--blue)">
                <div class="label-sm" style="color:var(--blue)">Total Factory Valuation</div>
                <div id="fac_val" class="val">Rs. 0</div>
                <div class="grid-2" style="margin-top:12px; font-size:12px; gap: 20px;">
                    <div>
                        <span style="color:var(--text-secondary)">Total CBM:</span>
                        <strong id="total_cbm" style="color:var(--neon)">0 m¬≥</strong>
                    </div>
                    <div>
                        <span style="color:var(--text-secondary)">Total SQM:</span>
                        <strong id="total_sqm" style="color:var(--neon)">0 m¬≤</strong>
                    </div>
                </div>
            </div>

            <div class="calc-box" style="border-left-color: var(--red)">
                <div class="label-sm" style="color:var(--red)">Shrinkage Analysis</div>
                <div class="grid-2" style="font-size:13px; gap: 16px;">
                    <div>
                        <div style="color:var(--text-secondary); font-size:11px;">Percentage</div>
                        <div id="shrink_percent" style="font-size:20px; font-weight:700; color:var(--red)">0%</div>
                    </div>
                    <div>
                        <div style="color:var(--text-secondary); font-size:11px;">Absolute (SQFT)</div>
                        <div id="shrink_sqft" style="font-size:20px; font-weight:700; color:var(--red)">0 sqft</div>
                    </div>
                    <div>
                        <div style="color:var(--text-secondary); font-size:11px;">CBM Lost</div>
                        <div id="shrink_cbm" style="font-size:20px; font-weight:700; color:var(--red)">0 m¬≥</div>
                    </div>
                    <div>
                        <div style="color:var(--text-secondary); font-size:11px;">SQM Lost</div>
                        <div id="shrink_sqm" style="font-size:20px; font-weight:700; color:var(--red)">0 m¬≤</div>
                    </div>
                </div>
            </div>

            <div class="section-header">Lot Performance</div>
            <div id="lot_grid"></div>
        </div>

        <!-- INVENTORY PANEL -->
        <div id="inventory" class="panel">
            <div class="panel-header">
                <h2>Inventory Classification</h2>
                <div style="display: flex; gap: 8px;">
                    <button class="export-btn" onclick="exportInventoryToExcel()">üìä Excel</button>
                    <button class="export-btn" onclick="exportInventoryToPDF()">üìÑ PDF</button>
                    <button class="export-btn" onclick="emailInventory()">üìß Email</button>
                </div>
            </div>

            <div class="calc-box" style="border-left-color:var(--orange)">
                <div class="label-sm">Total Available Stock</div>
                <div id="inv_total_sqft" class="val">0 SQFT</div>
                <div id="inv_total_count" style="font-size:12px; color:var(--text-secondary); margin-top:4px">0 Slabs</div>
            </div>

            <div id="inventory_classification"></div>
            
            <div class="section-header">All Slabs - Click to Edit</div>
            <div id="all_slabs_list"></div>
        </div>

        <!-- SALES PANEL -->
        <div id="sales" class="panel">
            <div class="panel-header">
                <h2>Sales Entry</h2>
                <button class="export-btn" onclick="exportSales()">üìä EXPORT SALES</button>
            </div>
            
            <label class="label-sm">Select Available Slab</label>
            <select id="sale_slab_list" onchange="updateSaleFields()"></select>
            
            <label class="label-sm">Customer Name</label>
            <input type="text" id="sale_customer" placeholder="Enter customer name">
            
            <div class="grid-2">
                <div>
                    <label class="label-sm">Original SQFT</label>
                    <input type="number" id="sale_original_sqft" readonly style="background: var(--bg-secondary);">
                </div>
                <div>
                    <label class="label-sm">Sold SQFT</label>
                    <input type="number" id="sale_sold_sqft" placeholder="Actual sold" oninput="updateSaleSummary()">
                </div>
            </div>
            
            <label class="label-sm">Price per SQFT (Rs.)</label>
            <input type="number" id="sale_price_sqft" placeholder="0.00" oninput="updateSaleSummary()">
            
            <div class="calc-box" style="border-left-color: var(--blue); margin-top: 20px;">
                <div class="label-sm">Sale Summary</div>
                <div id="sale_summary" style="font-size: 14px; color: var(--text-secondary);">
                    Fill in the details to see summary
                </div>
            </div>
            
            <button class="save-btn" onclick="recordSale()">‚úì Record Sale</button>

            <div class="section-header">Sales History</div>
            <div id="sales_history"></div>
        </div>

        <!-- LOT ENTRY PANEL -->
        <div id="mass" class="panel">
            <div class="panel-header">
                <h2>Register New Lot</h2>
            </div>
            
            <label class="label-sm">Lot ID</label>
            <input type="text" id="m_lot" placeholder="Enter unique lot identifier">
            
            <label class="label-sm">Purchase Price (Lakhs)</label>
            <input type="number" id="m_cost" placeholder="0.00" step="0.01">
            
            <button class="save-btn" onclick="saveMass()">‚úì Register Lot</button>
        </div>

        <!-- BLOCK PANEL -->
        <div id="block" class="panel">
            <div class="panel-header">
                <h2>Add Block</h2>
            </div>
            
            <label class="label-sm">Select Active Lot</label>
            <select id="b_lot_list"></select>
            
            <label class="label-sm">Block ID</label>
            <input type="text" id="b_id" placeholder="Enter block identifier">
            
            <label class="label-sm">Lengths (cm) - Enter 4 measurements</label>
            <div class="grid-2">
                <input type="number" class="b_l" placeholder="L1">
                <input type="number" class="b_l" placeholder="L2">
                <input type="number" class="b_l" placeholder="L3">
                <input type="number" class="b_l" placeholder="L4">
            </div>
            
            <label class="label-sm">Heights (cm)</label>
            <div class="grid-2">
                <input type="number" class="b_h" placeholder="H1">
                <input type="number" class="b_h" placeholder="H2">
                <input type="number" class="b_h" placeholder="H3">
                <input type="number" class="b_h" placeholder="H4">
            </div>
            
            <label class="label-sm">Widths (cm)</label>
            <div class="grid-2">
                <input type="number" class="b_w" placeholder="W1">
                <input type="number" class="b_w" placeholder="W2">
                <input type="number" class="b_w" placeholder="W3">
                <input type="number" class="b_w" placeholder="W4">
            </div>
            
            <button class="save-btn" onclick="saveBlock()">‚úì Save Block</button>
            
            <div class="section-header">Active Blocks - Click to Manage</div>
            <div id="active_blocks_list"></div>
        </div>

        <!-- SLAB CUTTING PANEL -->
        <div id="slab" class="panel">
            <div class="panel-header">
                <h2>Record Cut Slab</h2>
            </div>
            
            <label class="label-sm">Select Active Block</label>
            <select id="s_block_list"></select>
            
            <label class="label-sm">Slab Number (Custom ID)</label>
            <input type="text" id="s_slab_number" placeholder="e.g., SLAB-001, S-123">
            
            <label class="label-sm">Thickness</label>
            <select id="s_thick">
                <option value="2cm">2 cm</option>
                <option value="3cm">3 cm</option>
            </select>
            
            <label class="label-sm">Dimensions (inches)</label>
            <div class="grid-2">
                <input type="number" id="s_l" placeholder="Length">
                <input type="number" id="s_h" placeholder="Height">
            </div>
            
            <button class="save-btn" onclick="saveSlab()">‚úì Save Raw Cut</button>
            
            <div class="section-header">Active Blocks Progress</div>
            <div id="blocks_progress"></div>
        </div>

        <!-- POLISH PANEL -->
        <div id="polish" class="panel">
            <div class="panel-header">
                <h2>Finalize Polish</h2>
            </div>
            
            <label class="label-sm">Select Raw Slab</label>
            <select id="p_slab_list" onchange="autoFillPolishDimensions()"></select>
            
            <div class="calc-box" style="border-left-color: var(--orange); margin-bottom: 16px;">
                <div class="label-sm">Original Cutting Dimensions</div>
                <div id="original_dimensions" style="font-size: 14px; color: var(--text-secondary);">
                    Select a slab to see original dimensions
                </div>
            </div>
            
            <label class="label-sm">Net Dimensions (inches) - Auto-filled, adjust if edges trimmed</label>
            <div class="grid-2">
                <input type="number" id="p_l" placeholder="Net Length" step="0.1">
                <input type="number" id="p_h" placeholder="Net Height" step="0.1">
            </div>
            
            <label class="label-sm">Quality Grade</label>
            <select id="p_q">
                <option value="150">Premium (Rs. 150/sqft)</option>
                <option value="100">Standard (Rs. 100/sqft)</option>
                <option value="75">Commercial (Rs. 75/sqft)</option>
            </select>
            
            <button class="save-btn" onclick="savePolish()">‚úì Finalize Slab</button>
        </div>

        <!-- USER MANAGEMENT PANEL (Admin Only) -->
        <div id="users" class="panel">
            <div class="panel-header">
                <h2>User Management</h2>
                <button class="export-btn" onclick="refreshUsers()">üîÑ Refresh</button>
            </div>

            <div class="calc-box" style="border-left-color: var(--blue)">
                <div class="label-sm" style="color: var(--blue)">Add New User</div>
                <label class="label-sm">Username</label>
                <input type="text" id="new_username" placeholder="Enter username">
                
                <label class="label-sm">Password</label>
                <input type="text" id="new_password" placeholder="Enter password">
                
                <label class="label-sm">Role</label>
                <select id="new_role">
                    <option value="admin">Admin / Sales Team</option>
                    <option value="supervisor">Factory Supervisor</option>
                </select>
                
                <button class="save-btn" onclick="addUser()">‚úì Add User</button>
            </div>

            <div class="section-header">All Users</div>
            <div id="users_list"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    let supabaseClient = null;
    let currentUser = null;
    let currentRole = null;
    
    const menuConfig = {
        admin: ['summary', 'inventory', 'sales', 'mass', 'block', 'slab', 'polish', 'users'],
        supervisor: ['summary', 'inventory', 'mass', 'block', 'slab', 'polish']
    };
    
    const menuNames = {
        summary: 'Dashboard',
        inventory: 'Inventory',
        sales: 'Sales',
        mass: 'Lot Entry',
        block: 'Block',
        slab: 'Cut',
        polish: 'Polish',
        users: 'Users'
    };
    
    // Initialize app on load
    window.addEventListener('load', function() {
        initApp();
    });
    
    function initApp() {
        // PRE-CONFIGURED SUPABASE CREDENTIALS
        // Replace these with your actual Supabase credentials
        const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';  // e.g., https://xxxxx.supabase.co
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';  // Your anon/public key
        
        // Check if credentials are configured
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
            // Fallback to localStorage if not hardcoded
            const config = JSON.parse(localStorage.getItem('supabase_config') || '{}');
            
            if (!config.url || !config.key) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
                document.getElementById('setup').style.display = 'block';
                return;
            }
            
            supabaseClient = window.supabase.createClient(config.url, config.key);
        } else {
            // Use hardcoded credentials
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
        
        if (typeof window.supabase === 'undefined') {
            alert('Error: Supabase library failed to load. Please refresh.');
            return;
        }
        
        const session = JSON.parse(localStorage.getItem('user_session') || '{}');
        
        if (session.role) {
            currentUser = session.user;
            currentRole = session.role;
            showMainApp();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }
    }
    
    function doLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!username || !password) {
            alert('Please enter username and password');
            return;
        }
        
        if (!supabaseClient) {
            alert('‚ö†Ô∏è Database not configured. Please complete setup first.');
            return;
        }
        
        // Authenticate with Supabase
        authenticateUser(username, password);
    }
    
    async function authenticateUser(username, password) {
        try {
            const { data: users, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('username', username)
                .eq('password', password)
                .single();
            
            if (error || !users) {
                alert('‚ùå Invalid username or password');
                return;
            }
            
            // Login successful
            currentUser = username;
            currentRole = users.role;
            localStorage.setItem('user_session', JSON.stringify({ 
                user: currentUser, 
                role: currentRole,
                userId: users.id 
            }));
            
            showMainApp();
        } catch (error) {
            alert('‚ùå Login failed: ' + error.message);
        }
    }
    
    function doLogout() {
        localStorage.removeItem('user_session');
        location.reload();
    }
    
    function openPasswordManager() {
        if (!currentRole || currentRole !== 'admin') {
            alert('‚ö†Ô∏è Only admins can access user management.\n\nPlease go to the "Users" tab after logging in as admin.');
            return;
        }
        
        alert('üìã Password Management\n\nTo manage users and passwords:\n1. Login as Admin\n2. Go to "Users" tab\n3. Add/Edit/Delete users');
    }
    
    function resetPasswords() {
        alert('üîÑ Password Reset\n\nPasswords are now managed in the database.\n\nTo reset:\n1. Go to Supabase ‚Üí Table Editor ‚Üí users table\n2. Edit the password directly\n\nOr login as admin and use the Users tab.');
    }
    
    function showCurrentPasswords() {
        alert('üìã View Passwords\n\nPasswords are stored in Supabase.\n\nTo view:\n1. Go to Supabase ‚Üí Table Editor ‚Üí users table\n2. View the password column\n\nOr login as admin and use the Users tab.');
    }
    
    function doLogout() {
        localStorage.removeItem('user_session');
        location.reload();
    }
    
    function openPasswordManager() {
        const passwords = JSON.parse(localStorage.getItem('app_passwords') || '{}');
        const currentAdmin = passwords.admin || 'admin';
        const currentSupervisor = passwords.supervisor || 'supervisor';
        
        const html = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;" id="passwordModal" onclick="if(event.target.id==='passwordModal') closePasswordModal()">
                <div style="background: var(--card); padding: 40px; border-radius: 16px; border: 2px solid var(--neon); max-width: 400px; width: 100%;" onclick="event.stopPropagation()">
                    <h3 style="color: var(--neon); margin-bottom: 20px;">üîê Change Passwords</h3>
                    
                    <label class="label-sm">Admin Password (Current: ${currentAdmin})</label>
                    <input type="text" id="new_admin_pass" placeholder="Enter new admin password" style="margin-bottom: 20px;">
                    
                    <label class="label-sm">Supervisor Password (Current: ${currentSupervisor})</label>
                    <input type="text" id="new_supervisor_pass" placeholder="Enter new supervisor password" style="margin-bottom: 20px;">
                    
                    <p style="font-size: 11px; color: var(--text-secondary); margin-bottom: 20px;">
                        Leave blank to keep current password
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="save-btn" onclick="savePasswords()" style="margin: 0;">üíæ Save</button>
                        <button class="save-btn" onclick="closePasswordModal()" style="margin: 0; background: var(--red);">‚úï Cancel</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function savePasswords() {
        const adminPass = document.getElementById('new_admin_pass').value.trim();
        const supervisorPass = document.getElementById('new_supervisor_pass').value.trim();
        
        if (!adminPass && !supervisorPass) {
            alert('Please enter at least one password to change');
            return;
        }
        
        const passwords = JSON.parse(localStorage.getItem('app_passwords') || '{}');
        
        if (adminPass) passwords.admin = adminPass;
        if (supervisorPass) passwords.supervisor = supervisorPass;
        
        localStorage.setItem('app_passwords', JSON.stringify(passwords));
        
        let msg = '‚úÖ Passwords updated successfully!\n\n';
        if (adminPass) msg += 'üîπ Admin: ' + adminPass + '\n';
        if (supervisorPass) msg += 'üîπ Supervisor: ' + supervisorPass;
        
        alert(msg);
        closePasswordModal();
    }
    
    function closePasswordModal() {
        const modal = document.getElementById('passwordModal');
        if (modal) modal.remove();
    }
    
    function showMainApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('currentUser').textContent = currentUser + ' (' + (currentRole === 'admin' ? 'Admin' : 'Supervisor') + ')';
        
        const nav = document.getElementById('mainNav');
        nav.innerHTML = '';
        menuConfig[currentRole].forEach((panelId, index) => {
            const btn = document.createElement('button');
            btn.textContent = menuNames[panelId];
            btn.onclick = () => showPanel(panelId, btn);
            if (index === 0) btn.classList.add('active');
            nav.appendChild(btn);
        });
        
        showPanel(menuConfig[currentRole][0], nav.firstChild);
        refreshData();
        
        // Load users if admin
        if (currentRole === 'admin') {
            refreshUsers();
        }
    }
    
    function showPanel(id, btn) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (btn) btn.classList.add('active');
    }

    function saveSupabaseConfig() {
        const url = document.getElementById('supabase_url').value.trim();
        const key = document.getElementById('supabase_key').value.trim();
        
        if (!url || !key) {
            alert('Please enter both URL and Key');
            return;
        }
        
        if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
            alert('Invalid Supabase URL');
            return;
        }
        
        localStorage.setItem('supabase_config', JSON.stringify({ url, key }));
        alert('Configuration saved! Refreshing...');
        setTimeout(() => location.reload(), 500);
    }
    
    async function testConnection() {
        const url = document.getElementById('supabase_url').value.trim();
        const key = document.getElementById('supabase_key').value.trim();
        
        if (!url || !key) {
            alert('Please enter credentials first');
            return;
        }
        
        try {
            const testClient = window.supabase.createClient(url, key);
            const { error } = await testClient.from('lots').select('count');
            
            if (error && error.code === '42P01') {
                alert('‚úÖ Connection OK! ‚ö†Ô∏è Please run SQL to create tables.');
            } else if (error) {
                alert('‚ùå Failed: ' + error.message);
            } else {
                alert('‚úÖ Connected! Tables ready.');
            }
        } catch (error) {
            alert('‚ùå Test failed: ' + error.message);
        }
    }

    async function refreshData() {
        if (!supabaseClient) return;
        
        const btn = document.querySelector('.sync-btn');
        if(btn) {
            btn.innerText = "‚è≥ Syncing...";
            btn.disabled = true;
        }
        
        try {
            const { data: lots } = await supabaseClient.from('lots').select('*');
            const { data: blocks } = await supabaseClient.from('blocks').select('*');
            const { data: slabs } = await supabaseClient.from('slabs').select('*');
            const { data: sales } = await supabaseClient.from('sales').select('*');
            
            const lotAnalysis = {};
            const blockToLotMap = {};
            const factoryTotal = { 
                invest: 0, currentVal: 0, netSqft: 0, grossSqft: 0, count: 0,
                totalCBM: 0, grossCBM: 0, netCBM: 0
            };
            
            const inventoryByQuality = {
                Premium: {},
                Standard: {},
                Commercial: {}
            };
            
            (lots || []).forEach(lot => {
                lotAnalysis[lot.lot_id] = {
                    invest: parseFloat(lot.cost) * 100000,
                    cbm: 0,
                    rawSqft: 0,
                    netSqft: 0,
                    value: 0
                };
                factoryTotal.invest += lotAnalysis[lot.lot_id].invest;
            });
            
            (blocks || []).forEach(block => {
                const key = `${block.lot_id}-${block.block_id}`;
                blockToLotMap[key] = block.lot_id;
                const cbm = parseFloat(block.volume || 0);
                if (lotAnalysis[block.lot_id]) {
                    lotAnalysis[block.lot_id].cbm += cbm;
                }
                factoryTotal.totalCBM += cbm;
                factoryTotal.grossCBM += cbm;
            });
            
            const availableSlabs = [];
            (slabs || []).forEach(slab => {
                const lotId = blockToLotMap[slab.block_id];
                const sqft = parseFloat(slab.sqft || 0);
                
                if (slab.status === 'POLISHED' && lotId && lotAnalysis[lotId]) {
                    const isSold = (sales || []).some(s => s.slab_id === slab.id);
                    
                    if (!isSold) {
                        availableSlabs.push(slab);
                        
                        const rate = parseInt(slab.rate || 75);
                        const quality = rate === 150 ? 'Premium' : (rate === 100 ? 'Standard' : 'Commercial');
                        const lengthCM = parseFloat(slab.length) * 2.54;
                        
                        let lengthKey;
                        if (quality === 'Premium') {
                            lengthKey = lengthCM >= 300 ? '300+' : lengthCM >= 250 ? '250-300' : 
                                       lengthCM >= 240 ? '240-250' : lengthCM >= 220 ? '220-240' : 
                                       lengthCM >= 200 ? '200-220' : '<200';
                        } else {
                            lengthKey = lengthCM >= 200 ? '200+' : lengthCM >= 180 ? '180-200' : 
                                       lengthCM >= 160 ? '160-180' : lengthCM >= 150 ? '150-160' : 
                                       lengthCM >= 100 ? '100-150' : '<100';
                        }
                        
                        if (!inventoryByQuality[quality][lengthKey]) {
                            inventoryByQuality[quality][lengthKey] = { count: 0, sqft: 0 };
                        }
                        inventoryByQuality[quality][lengthKey].count++;
                        inventoryByQuality[quality][lengthKey].sqft += sqft;
                    }
                    
                    lotAnalysis[lotId].netSqft += sqft;
                    lotAnalysis[lotId].value += parseFloat(slab.value || 0);
                    factoryTotal.currentVal += parseFloat(slab.value || 0);
                    factoryTotal.netSqft += sqft;
                    factoryTotal.count++;
                } else if (lotId && lotAnalysis[lotId]) {
                    lotAnalysis[lotId].rawSqft += sqft;
                    factoryTotal.grossSqft += sqft;
                }
            });
            
            const shrinkSqft = factoryTotal.grossSqft - factoryTotal.netSqft;
            const shrinkPercent = factoryTotal.grossSqft > 0 ? 
                (shrinkSqft / factoryTotal.grossSqft * 100).toFixed(1) : 0;
            const shrinkCBM = (shrinkSqft / 10.764 * 0.02).toFixed(2);
            const shrinkSQM = (shrinkSqft / 10.764).toFixed(2);
            
            document.getElementById('fac_val').innerText = "Rs. " + factoryTotal.currentVal.toLocaleString('en-IN');
            document.getElementById('total_cbm').innerText = factoryTotal.totalCBM.toFixed(2) + " m¬≥";
            document.getElementById('total_sqm').innerText = (factoryTotal.netSqft / 10.764).toFixed(2) + " m¬≤";
            document.getElementById('shrink_percent').innerText = shrinkPercent + "%";
            document.getElementById('shrink_sqft').innerText = shrinkSqft.toFixed(0) + " sqft";
            document.getElementById('shrink_cbm').innerText = shrinkCBM + " m¬≥";
            document.getElementById('shrink_sqm').innerText = shrinkSQM + " m¬≤";
            
            let lotHtml = "";
            for (let id in lotAnalysis) {
                const d = lotAnalysis[id];
                const pl = d.value - d.invest;
                const shrink = d.rawSqft > 0 ? ((d.rawSqft - d.netSqft) / d.rawSqft * 100).toFixed(1) : 0;
                const plColor = pl >= 0 ? 'var(--neon)' : 'var(--red)';
                
                // Find lot status
                const lot = (lots || []).find(l => l.lot_id === id);
                const isActive = lot && lot.status === 'ACTIVE';
                const statusBadge = isActive ? 
                    '<span class="status-badge status-available">ACTIVE</span>' : 
                    '<span class="status-badge status-sold">COMPLETED</span>';
                
                lotHtml += `<div class="calc-box" style="border-left-color:${plColor}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div class="label-sm" style="color:${plColor}">${id} ${statusBadge}</div>
                            <div style="font-size:18px; font-weight:700; color:${plColor}; margin: 8px 0;">
                                ${pl >= 0 ? '+' : ''} Rs. ${pl.toLocaleString('en-IN')}
                            </div>
                            <div style="font-size:11px; color:var(--text-secondary);">
                                Shrinkage: <span style="font-weight:600">${shrink}%</span> | 
                                CBM: <span style="font-weight:600">${d.cbm.toFixed(2)} m¬≥</span>
                            </div>
                        </div>
                        ${isActive ? `<button onclick="completeLot('${id}')" style="background:var(--neon); border:none; padding:8px 16px; border-radius:8px; color:#000; cursor:pointer; font-size:11px; font-weight:700; white-space:nowrap; margin-left: 10px;">Mark Complete</button>` : ''}
                    </div>
                </div>`;
            }
            document.getElementById('lot_grid').innerHTML = lotHtml || 
                '<div style="text-align:center; padding:40px; color:var(--text-secondary)">No lots registered</div>';
            
            document.getElementById('inv_total_sqft').innerText = factoryTotal.netSqft.toFixed(0) + " SQFT";
            document.getElementById('inv_total_count').innerText = availableSlabs.length + " Slabs";
            
            let invHtml = "";
            ['Premium', 'Standard', 'Commercial'].forEach(quality => {
                if (Object.keys(inventoryByQuality[quality]).length > 0) {
                    invHtml += `<div class="section-header">${quality} Stock</div>`;
                    Object.entries(inventoryByQuality[quality])
                        .sort((a, b) => {
                            const order = quality === 'Premium' ? 
                                ['300+', '250-300', '240-250', '220-240', '200-220', '<200'] :
                                ['200+', '180-200', '160-180', '150-160', '100-150', '<100'];
                            return order.indexOf(a[0]) - order.indexOf(b[0]);
                        })
                        .forEach(([range, data]) => {
                            invHtml += `<div class="stock-row">
                                <span>${data.count} slabs ¬∑ Length ${range} cm</span>
                                <span style="font-weight:700">${data.sqft.toFixed(0)} sqft</span>
                            </div>`;
                        });
                }
            });
            document.getElementById('inventory_classification').innerHTML = invHtml || 
                '<div style="text-align:center; padding:40px; color:var(--text-secondary)">No inventory</div>';
            
            // All slabs list with edit option
            let allSlabsHtml = '<table class="inventory-table"><tr><th>Slab #</th><th>Block</th><th>Status</th><th>Dimensions</th><th>SQFT</th><th>Quality</th><th>Action</th></tr>';
            (slabs || []).forEach(slab => {
                const quality = slab.rate ? (slab.rate == 150 ? 'Premium' : slab.rate == 100 ? 'Standard' : 'Commercial') : 'Raw';
                const isSold = (sales || []).some(s => s.slab_id === slab.id);
                allSlabsHtml += `<tr>
                    <td>${slab.slab_number || slab.id}</td>
                    <td>${slab.block_id}</td>
                    <td><span class="status-badge ${isSold ? 'status-sold' : 'status-available'}">${isSold ? 'SOLD' : slab.status}</span></td>
                    <td>${slab.length}" √ó ${slab.height}"</td>
                    <td>${slab.sqft}</td>
                    <td>${quality}</td>
                    <td><button onclick="editSlab(${slab.id})" style="background:var(--blue); border:none; padding:6px 12px; border-radius:4px; color:#000; cursor:pointer; font-size:11px; font-weight:700;">Edit</button></td>
                </tr>`;
            });
            allSlabsHtml += '</table>';
            document.getElementById('all_slabs_list').innerHTML = allSlabsHtml;
            
            document.getElementById('b_lot_list').innerHTML = (lots || [])
                .filter(l => l.status === 'ACTIVE')
                .map(l => `<option value="${l.lot_id}">${l.lot_id}</option>`).join('') || 
                '<option>No active lots</option>';
            
            document.getElementById('s_block_list').innerHTML = (blocks || [])
                .filter(b => b.status === 'ACTIVE')
                .map(b => `<option value="${b.lot_id}-${b.block_id}">${b.lot_id}-${b.block_id}</option>`).join('') || 
                '<option>No active blocks</option>';
            
            // Show active blocks with management options
            let activeBlocksHtml = '';
            const activeBlocks = (blocks || []).filter(b => b.status === 'ACTIVE');
            
            if (activeBlocks.length > 0) {
                activeBlocksHtml = '<table class="inventory-table"><tr><th>Block ID</th><th>Lot</th><th>Volume (m¬≥)</th><th>Action</th></tr>';
                activeBlocks.forEach(block => {
                    activeBlocksHtml += `<tr>
                        <td><strong>${block.block_id}</strong></td>
                        <td>${block.lot_id}</td>
                        <td>${parseFloat(block.volume).toFixed(3)}</td>
                        <td>
                            <button onclick="completeBlock('${block.lot_id}', '${block.block_id}')" style="background:var(--neon); border:none; padding:6px 12px; border-radius:4px; color:#000; cursor:pointer; font-size:11px; font-weight:700; margin-right:5px;">‚úì Complete</button>
                            <button onclick="deleteBlock(${block.id}, '${block.lot_id}-${block.block_id}')" style="background:var(--red); border:none; padding:6px 12px; border-radius:4px; color:#fff; cursor:pointer; font-size:11px; font-weight:700;">Delete</button>
                        </td>
                    </tr>`;
                });
                activeBlocksHtml += '</table>';
            } else {
                activeBlocksHtml = '<div style="text-align:center; padding:40px; color:var(--text-secondary)">No active blocks</div>';
            }
            document.getElementById('active_blocks_list').innerHTML = activeBlocksHtml;
            
            // Show blocks progress in cutting panel
            let progressHtml = '';
            activeBlocks.forEach(block => {
                const blockKey = `${block.lot_id}-${block.block_id}`;
                const slabCount = (slabs || []).filter(s => s.block_id === blockKey).length;
                progressHtml += `<div class="calc-box" style="border-left-color: var(--blue)">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="label-sm">${blockKey}</div>
                            <div style="font-size: 16px; font-weight: 700;">${slabCount} slabs cut</div>
                        </div>
                        <button onclick="completeBlock('${block.lot_id}', '${block.block_id}')" style="background:var(--neon); border:none; padding:8px 16px; border-radius:8px; color:#000; cursor:pointer; font-size:11px; font-weight:700;">Mark Complete</button>
                    </div>
                </div>`;
            });
            document.getElementById('blocks_progress').innerHTML = progressHtml || '<div style="text-align:center; padding:40px; color:var(--text-secondary)">No active blocks</div>';
            
            const rawSlabs = (slabs || []).filter(s => s.status === 'RAW');
            document.getElementById('p_slab_list').innerHTML = rawSlabs
                .map(s => `<option value="${s.id}">${s.slab_number || s.id} | ${s.block_id}</option>`).join('') || 
                '<option>No raw slabs</option>';
            
            document.getElementById('sale_slab_list').innerHTML = '<option value="">Select slab...</option>' +
                availableSlabs.map(s => {
                    const quality = parseInt(s.rate) === 150 ? 'Premium' : (parseInt(s.rate) === 100 ? 'Standard' : 'Commercial');
                    return `<option value="${s.id}" data-sqft="${s.sqft}" data-block="${s.block_id}">
                        ${s.slab_number || s.id} | ${s.block_id} | ${s.sqft} sqft | ${quality}
                    </option>`;
                }).join('');
            
            if (sales && sales.length > 0) {
                let salesHtml = `<table class="inventory-table">
                    <tr>
                        <th>Slab #</th>
                        <th>Customer</th>
                        <th>Original</th>
                        <th>Sold</th>
                        <th>Loss</th>
                        <th>Value</th>
                    </tr>`;
                sales.forEach(sale => {
                    salesHtml += `<tr>
                        <td>${sale.slab_number}</td>
                        <td>${sale.customer_name}</td>
                        <td>${sale.original_sqft} sqft</td>
                        <td>${sale.sold_sqft} sqft</td>
                        <td style="color:var(--red)">${sale.shrinkage_sqft} sqft</td>
                        <td style="color:var(--neon)">Rs. ${parseFloat(sale.total_value).toLocaleString('en-IN')}</td>
                    </tr>`;
                });
                salesHtml += '</table>';
                document.getElementById('sales_history').innerHTML = salesHtml;
            } else {
                document.getElementById('sales_history').innerHTML = 
                    '<div style="text-align:center; padding:40px; color:var(--text-secondary)">No sales recorded</div>';
            }
            
        } catch (error) {
            console.error('Error:', error);
            alert('Error loading data: ' + error.message);
        } finally {
            if(btn) {
                btn.innerText = "üîÑ Sync Dashboard";
                btn.disabled = false;
            }
        }
    }

    function updateSaleFields() {
        const select = document.getElementById('sale_slab_list');
        const selected = select.options[select.selectedIndex];
        const originalSqft = selected.getAttribute('data-sqft');
        document.getElementById('sale_original_sqft').value = originalSqft || '';
        updateSaleSummary();
    }
    
    function updateSaleSummary() {
        const original = parseFloat(document.getElementById('sale_original_sqft').value) || 0;
        const sold = parseFloat(document.getElementById('sale_sold_sqft').value) || 0;
        const price = parseFloat(document.getElementById('sale_price_sqft').value) || 0;
        
        if (original && sold && price) {
            const shrinkage = original - sold;
            const totalValue = sold * price;
            const shrinkPercent = (shrinkage / original * 100).toFixed(1);
            
            document.getElementById('sale_summary').innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div>
                        <div style="color:var(--text-secondary)">Shrinkage</div>
                        <div style="color:var(--red); font-weight:700">${shrinkage.toFixed(2)} sqft (${shrinkPercent}%)</div>
                    </div>
                    <div>
                        <div style="color:var(--text-secondary)">Total Value</div>
                        <div style="color:var(--neon); font-weight:700">Rs. ${totalValue.toLocaleString('en-IN')}</div>
                    </div>
                </div>
            `;
        }
    }

    async function recordSale() {
        if (!supabaseClient) {
            alert('‚ö†Ô∏è Supabase not configured!');
            return;
        }
        
        const slabId = document.getElementById('sale_slab_list').value;
        const customer = document.getElementById('sale_customer').value.trim();
        const originalSqft = parseFloat(document.getElementById('sale_original_sqft').value);
        const soldSqft = parseFloat(document.getElementById('sale_sold_sqft').value);
        const priceSqft = parseFloat(document.getElementById('sale_price_sqft').value);
        
        if (!slabId || !customer || !soldSqft || !priceSqft) {
            alert('Please fill all fields');
            return;
        }
        
        const shrinkage = originalSqft - soldSqft;
        const totalValue = soldSqft * priceSqft;
        
        try {
            const { data: slab } = await supabaseClient
                .from('slabs')
                .select('block_id')
                .eq('id', slabId)
                .single();
            
            const lotId = slab.block_id.split('-')[0];
            
            const { error } = await supabaseClient.from('sales').insert([{
                slab_id: parseInt(slabId),
                lot_id: lotId,
                block_id: slab.block_id,
                slab_number: `${slab.block_id}-${slabId}`,
                customer_name: customer,
                original_sqft: originalSqft,
                sold_sqft: soldSqft,
                price_per_sqft: priceSqft,
                total_value: totalValue,
                shrinkage_sqft: shrinkage
            }]);
            
            if (error) throw error;
            
            document.getElementById('sale_slab_list').selectedIndex = 0;
            document.getElementById('sale_customer').value = '';
            document.getElementById('sale_original_sqft').value = '';
            document.getElementById('sale_sold_sqft').value = '';
            document.getElementById('sale_price_sqft').value = '';
            document.getElementById('sale_summary').innerHTML = 'Fill in the details to see summary';
            
            await refreshData();
            alert('Sale recorded successfully!');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function saveMass() {
        if (!supabaseClient) {
            alert('‚ö†Ô∏è Supabase not configured!');
            return;
        }
        
        const lot = document.getElementById('m_lot').value.trim();
        const cost = parseFloat(document.getElementById('m_cost').value);
        
        if (!lot || !cost) {
            alert('Please fill all fields');
            return;
        }
        
        try {
            const { error } = await supabaseClient.from('lots').insert([
                { lot_id: lot, cost: cost, status: 'ACTIVE' }
            ]);
            
            if (error) throw error;
            
            document.getElementById('m_lot').value = '';
            document.getElementById('m_cost').value = '';
            await refreshData();
            alert('Lot registered!');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function completeLot(lotId) {
        if (!supabaseClient) return;
        
        // Check if all blocks are completed
        const { data: blocks } = await supabaseClient
            .from('blocks')
            .select('status')
            .eq('lot_id', lotId);
        
        const hasActiveBlocks = blocks && blocks.some(b => b.status === 'ACTIVE');
        
        if (hasActiveBlocks) {
            const activeCount = blocks.filter(b => b.status === 'ACTIVE').length;
            if (!confirm(`‚ö†Ô∏è This lot still has ${activeCount} ACTIVE block(s)!\n\nAre you sure you want to mark the lot as complete?`)) {
                return;
            }
        }
        
        if (!confirm(`Mark lot "${lotId}" as COMPLETED?\n\nThis will:\n‚úì Hide it from active lot dropdown\n‚úì Keep all data for historical records\n‚úì Show as "COMPLETED" in dashboard`)) {
            return;
        }
        
        try {
            const { error } = await supabaseClient
                .from('lots')
                .update({ status: 'COMPLETED' })
                .eq('lot_id', lotId);
            
            if (error) throw error;
            
            alert(`‚úÖ Lot "${lotId}" marked as COMPLETED!`);
            await refreshData();
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function saveBlock() {
        if (!supabaseClient) {
            alert('‚ö†Ô∏è Supabase not configured!');
            return;
        }
        
        const getMin = (cls) => {
            const v = Array.from(document.getElementsByClassName(cls))
                .map(i => parseFloat(i.value)).filter(v => v > 0);
            return v.length ? Math.min(...v) : 0;
        };
        
        const l = getMin('b_l');
        const h = getMin('b_h');
        const w = getMin('b_w');
        const lotId = document.getElementById('b_lot_list').value;
        const blockId = document.getElementById('b_id').value.trim();
        
        if (!l || !h || !w || !blockId) {
            alert('Please enter all fields');
            return;
        }
        
        const v = (l * h * w) / 1000000;
        
        try {
            const { error } = await supabaseClient.from('blocks').insert([{
                lot_id: lotId,
                block_id: blockId,
                length: l,
                width: w,
                height: h,
                volume: v.toFixed(3),
                status: 'ACTIVE'
            }]);
            
            if (error) throw error;
            
            document.getElementById('b_id').value = '';
            document.querySelectorAll('.b_l, .b_h, .b_w').forEach(i => i.value = '');
            await refreshData();
            alert('Block saved!');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function completeBlock(lotId, blockId) {
        if (!supabaseClient) return;
        
        const blockKey = `${lotId}-${blockId}`;
        
        if (!confirm(`Mark block "${blockKey}" as COMPLETED?\n\nThis will:\n‚úì Hide it from cutting dropdown\n‚úì Keep all data for records\n‚úì Check if lot should auto-complete`)) {
            return;
        }
        
        try {
            // Update block status
            const { error: blockError } = await supabaseClient
                .from('blocks')
                .update({ status: 'COMPLETED' })
                .eq('lot_id', lotId)
                .eq('block_id', blockId);
            
            if (blockError) throw blockError;
            
            // Check if all blocks in this lot are completed
            const { data: lotBlocks } = await supabaseClient
                .from('blocks')
                .select('status')
                .eq('lot_id', lotId);
            
            const allCompleted = lotBlocks.every(b => b.status === 'COMPLETED');
            
            if (allCompleted) {
                // Auto-complete the lot
                const { error: lotError } = await supabaseClient
                    .from('lots')
                    .update({ status: 'COMPLETED' })
                    .eq('lot_id', lotId);
                
                if (lotError) throw lotError;
                
                alert(`‚úÖ Block completed!\n\nüéâ All blocks in lot "${lotId}" are now complete.\nLot has been marked as COMPLETED.`);
            } else {
                alert(`‚úÖ Block "${blockKey}" marked as completed!`);
            }
            
            await refreshData();
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function deleteBlock(blockId, blockName) {
        if (!supabaseClient) return;
        
        if (!confirm(`‚ö†Ô∏è DELETE block "${blockName}"?\n\nThis will permanently delete:\n‚Ä¢ The block record\n‚Ä¢ All slabs cut from this block\n\nThis CANNOT be undone!`)) {
            return;
        }
        
        try {
            // First check if there are any slabs
            const { data: slabs } = await supabaseClient
                .from('slabs')
                .select('id')
                .eq('block_id', blockName);
            
            if (slabs && slabs.length > 0) {
                if (!confirm(`This block has ${slabs.length} slabs!\n\nAre you SURE you want to delete everything?`)) {
                    return;
                }
                
                // Delete all slabs from this block
                await supabaseClient.from('slabs').delete().eq('block_id', blockName);
            }
            
            // Delete the block
            const { error } = await supabaseClient
                .from('blocks')
                .delete()
                .eq('id', blockId);
            
            if (error) throw error;
            
            alert('‚úÖ Block and all related slabs deleted!');
            await refreshData();
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function autoFillPolishDimensions() {
        const slabSelect = document.getElementById('p_slab_list');
        const slabId = slabSelect.value;
        
        if (!slabId || !supabaseClient) return;
        
        try {
            const { data: slab } = await supabaseClient
                .from('slabs')
                .select('*')
                .eq('id', slabId)
                .single();
            
            if (slab) {
                // Auto-fill with original dimensions
                document.getElementById('p_l').value = slab.length;
                document.getElementById('p_h').value = slab.height;
                
                // Show original dimensions
                document.getElementById('original_dimensions').innerHTML = `
                    Original Cut: <strong>${slab.length}" √ó ${slab.height}"</strong> = ${slab.sqft} sqft<br>
                    <span style="color: var(--orange); font-size: 12px;">Adjust below if edges were trimmed</span>
                `;
            }
        } catch (error) {
            console.error('Error loading slab dimensions:', error);
        }
    }
    
    async function saveSlab() {
        if (!supabaseClient) {
            alert('‚ö†Ô∏è Supabase not configured!');
            return;
        }
        
        const l = parseFloat(document.getElementById('s_l').value);
        const h = parseFloat(document.getElementById('s_h').value);
        const blockId = document.getElementById('s_block_list').value;
        const thickness = document.getElementById('s_thick').value;
        const slabNumber = document.getElementById('s_slab_number').value.trim();
        
        if (!l || !h || !slabNumber) {
            alert('Please enter all fields including slab number');
            return;
        }
        
        const sq = (l * h) / 144;
        
        try {
            const { error } = await supabaseClient.from('slabs').insert([{
                block_id: blockId,
                slab_number: slabNumber,
                status: 'RAW',
                length: l,
                height: h,
                sqft: sq.toFixed(2),
                thickness: thickness,
                rate: null,
                value: null
            }]);
            
            if (error) throw error;
            
            document.getElementById('s_l').value = '';
            document.getElementById('s_h').value = '';
            document.getElementById('s_slab_number').value = '';
            await refreshData();
            alert('Raw cut saved!');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function savePolish() {
        if (!supabaseClient) {
            alert('‚ö†Ô∏è Supabase not configured!');
            return;
        }
        
        const l = parseFloat(document.getElementById('p_l').value);
        const h = parseFloat(document.getElementById('p_h').value);
        const rate = parseFloat(document.getElementById('p_q').value);
        const rawSlabId = document.getElementById('p_slab_list').value;
        
        if (!l || !h || !rawSlabId) {
            alert('Please enter all fields');
            return;
        }
        
        const sq = (l * h) / 144;
        const value = sq * rate;
        
        try {
            const { data: rawSlab } = await supabaseClient
                .from('slabs')
                .select('*')
                .eq('id', rawSlabId)
                .single();
            
            const { error: insertError } = await supabaseClient.from('slabs').insert([{
                block_id: rawSlab.block_id,
                slab_number: rawSlab.slab_number,
                status: 'POLISHED',
                length: l,
                height: h,
                sqft: sq.toFixed(2),
                thickness: 'Final',
                rate: rate,
                value: value.toFixed(0)
            }]);
            
            if (insertError) throw insertError;
            
            const { error: deleteError } = await supabaseClient
                .from('slabs')
                .delete()
                .eq('id', rawSlabId);
            
            if (deleteError) throw deleteError;
            
            document.getElementById('p_l').value = '';
            document.getElementById('p_h').value = '';
            await refreshData();
            alert('Slab finalized!');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function editSlab(slabId) {
        if (!supabaseClient) return;
        
        try {
            const { data: slab } = await supabaseClient
                .from('slabs')
                .select('*')
                .eq('id', slabId)
                .single();
            
            const newLength = prompt('Enter new length (inches):', slab.length);
            const newHeight = prompt('Enter new height (inches):', slab.height);
            
            if (newLength && newHeight) {
                const l = parseFloat(newLength);
                const h = parseFloat(newHeight);
                const sqft = (l * h) / 144;
                const value = slab.rate ? sqft * slab.rate : null;
                
                const { error } = await supabaseClient
                    .from('slabs')
                    .update({
                        length: l,
                        height: h,
                        sqft: sqft.toFixed(2),
                        value: value ? value.toFixed(0) : null
                    })
                    .eq('id', slabId);
                
                if (error) throw error;
                
                await refreshData();
                alert('Slab updated successfully!');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function exportInventoryToExcel() {
        if (!supabaseClient) return;
        
        try {
            const { data: slabs } = await supabaseClient.from('slabs').select('*');
            const { data: sales } = await supabaseClient.from('sales').select('*');
            
            let csv = 'Slab Number,Block ID,Status,Length (in),Height (in),SQFT,Quality,Rate,Value\n';
            
            (slabs || []).forEach(slab => {
                const isSold = (sales || []).some(s => s.slab_id === slab.id);
                const quality = slab.rate ? (slab.rate == 150 ? 'Premium' : slab.rate == 100 ? 'Standard' : 'Commercial') : 'Raw';
                const status = isSold ? 'SOLD' : slab.status;
                
                csv += `${slab.slab_number || slab.id},${slab.block_id},${status},${slab.length},${slab.height},${slab.sqft},${quality},${slab.rate || ''},${slab.value || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            alert('‚úÖ Inventory exported to Excel/CSV!');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function exportInventoryToPDF() {
        alert('üìÑ PDF Export\n\nFor PDF export:\n1. Click Excel export first\n2. Open the CSV in Excel\n3. Use "Save As" ‚Üí PDF\n\nOr use browser Print ‚Üí Save as PDF on the Inventory page.');
    }
    
    async function emailInventory() {
        if (!supabaseClient) return;
        
        const email = prompt('Enter email address to send inventory report:');
        if (!email) return;
        
        try {
            const { data: slabs } = await supabaseClient.from('slabs').select('*').eq('status', 'POLISHED');
            const { data: sales } = await supabaseClient.from('sales').select('*');
            
            const availableSlabs = (slabs || []).filter(slab => {
                return !(sales || []).some(s => s.slab_id === slab.id);
            });
            
            let emailBody = `Inventory Report - ${new Date().toLocaleDateString()}\n\n`;
            emailBody += `Total Available Slabs: ${availableSlabs.length}\n`;
            emailBody += `Total SQFT: ${availableSlabs.reduce((sum, s) => sum + parseFloat(s.sqft), 0).toFixed(2)}\n\n`;
            emailBody += `Slab Details:\n`;
            emailBody += `${'='.repeat(50)}\n`;
            
            availableSlabs.forEach(slab => {
                const quality = slab.rate == 150 ? 'Premium' : slab.rate == 100 ? 'Standard' : 'Commercial';
                emailBody += `${slab.slab_number || slab.id} | ${slab.block_id} | ${slab.length}"x${slab.height}" | ${slab.sqft} sqft | ${quality}\n`;
            });
            
            const mailtoLink = `mailto:${email}?subject=Inventory Report - ${new Date().toLocaleDateString()}&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailtoLink;
            
            alert('‚úÖ Email client opened! Please send the email.');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    function exportInventory() {
        exportInventoryToExcel();
    }
    
    function exportSales() {
        alert('Sales export - CSV download coming soon!');
    }
    
    async function refreshUsers() {
        if (!supabaseClient) return;
        
        try {
            const { data: users, error } = await supabaseClient
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            let usersHtml = '<table class="inventory-table"><tr><th>Username</th><th>Role</th><th>Created</th><th>Action</th></tr>';
            
            (users || []).forEach(user => {
                const roleDisplay = user.role === 'admin' ? 'Admin / Sales' : 'Supervisor';
                const date = new Date(user.created_at).toLocaleDateString();
                
                usersHtml += `<tr>
                    <td><strong>${user.username}</strong></td>
                    <td>${roleDisplay}</td>
                    <td>${date}</td>
                    <td>
                        <button onclick="editUserPassword('${user.username}')" style="background:var(--blue); border:none; padding:6px 12px; border-radius:4px; color:#000; cursor:pointer; font-size:11px; font-weight:700; margin-right:5px;">Change Password</button>
                        <button onclick="deleteUser(${user.id}, '${user.username}')" style="background:var(--red); border:none; padding:6px 12px; border-radius:4px; color:#fff; cursor:pointer; font-size:11px; font-weight:700;">Delete</button>
                    </td>
                </tr>`;
            });
            
            usersHtml += '</table>';
            document.getElementById('users_list').innerHTML = usersHtml;
            
        } catch (error) {
            alert('Error loading users: ' + error.message);
        }
    }
    
    async function addUser() {
        if (!supabaseClient) return;
        
        const username = document.getElementById('new_username').value.trim();
        const password = document.getElementById('new_password').value.trim();
        const role = document.getElementById('new_role').value;
        
        if (!username || !password) {
            alert('Please fill all fields');
            return;
        }
        
        if (password.length < 4) {
            alert('Password must be at least 4 characters');
            return;
        }
        
        try {
            const { error } = await supabaseClient
                .from('users')
                .insert([{ username, password, role }]);
            
            if (error) {
                if (error.code === '23505') {
                    alert('‚ùå Username already exists');
                } else {
                    throw error;
                }
                return;
            }
            
            document.getElementById('new_username').value = '';
            document.getElementById('new_password').value = '';
            alert('‚úÖ User added successfully!');
            refreshUsers();
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function editUserPassword(username) {
        if (!supabaseClient) return;
        
        const newPassword = prompt(`Enter new password for "${username}":`);
        
        if (!newPassword) return;
        
        if (newPassword.length < 4) {
            alert('Password must be at least 4 characters');
            return;
        }
        
        try {
            const { error } = await supabaseClient
                .from('users')
                .update({ password: newPassword })
                .eq('username', username);
            
            if (error) throw error;
            
            alert(`‚úÖ Password updated for ${username}!\n\nNew password: ${newPassword}`);
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function deleteUser(userId, username) {
        if (!supabaseClient) return;
        
        if (!confirm(`Delete user "${username}"?\n\nThis cannot be undone.`)) {
            return;
        }
        
        try {
            const { error } = await supabaseClient
                .from('users')
                .delete()
                .eq('id', userId);
            
            if (error) throw error;
            
            alert('‚úÖ User deleted successfully!');
            refreshUsers();
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
</script>
</body>
</html>
